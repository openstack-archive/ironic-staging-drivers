- name: convert and write
  become: yes
  command: qemu-img convert -t directsync -O host_device /tmp/{{ inventory_hostname }}.img {{ ironic_root_device }}
  async: 400
  poll: 10
  when: "{{ image.disk_format != 'raw' }}"

- name: stream to target
  become: yes
  stream_url:
    url: "{{ image.url }}"
    dest: "{{ ironic_root_device }}"
    checksum: "md5:{{ image.checksum }}"
  async: 600
  poll: 15
  when:
    - image.torrent is none
    - "{{ image.disk_format == 'raw' }}"
- block:
  - name: mkdir
    file: path=/tmp/target state=directory mode=0755
  - name: link to device
    file: src={{ ironic_root_device }} dest=/tmp/target/{{ image.torrent.filename }} state=link
  - name: download
    become: yes
    command: aria2c --console-log-level=warn --check-certificate=false --file-allocation=none --allow-overwrite=true --seed-ratio=0.0 --bt-tracker-interval=2 --enable-dht=false --enable-dht6=false --disable-ipv6=true --enable-peer-exchange=true --bt-enable-lpd=true --follow-torrent=mem --dir=/tmp/target --bt-tracker-connect-timeout=2 --bt-tracker-timeout=5 --seed-time="{{ image.torrent.seed_time }}" "{{ image.url }}"
    async: 600
    poll: 15
  when:
    - image.torrent != none
    - image.disk_format == 'raw'

- name: flush
  command: sync
